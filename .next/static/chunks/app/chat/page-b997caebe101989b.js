(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[457],{5171:(e,t,l)=>{"use strict";l.d(t,{Y:()=>i,k:()=>o});var s=l(5155),a=l(2115),r=l(9829);let n=(0,a.createContext)();function o(e){let{children:t,user:l}=e,[o,i]=(0,a.useState)(null),[d,c]=(0,a.useState)([]),[u,m]=(0,a.useState)([]),[x,g]=(0,a.useState)({}),[h,b]=(0,a.useState)(!1),[f,p]=(0,a.useState)(0),[y,v]=(0,a.useState)({});(0,a.useEffect)(()=>{if(!(null==l?void 0:l.id))return;console.log("\uD83D\uDCAC Connecting to chat server...");let e=(0,r.Ay)("http://localhost:3001",{transports:["websocket","polling"],withCredentials:!0,reconnection:!0,reconnectionDelay:1e3,reconnectionAttempts:5});return e.on("connect",()=>{console.log("✅ Connected to chat server"),b(!0),e.emit("join",{userId:l.id})}),e.on("disconnect",()=>{console.log("❌ Disconnected from chat server"),b(!1)}),e.on("rooms",e=>{console.log("\uD83D\uDCCB Received rooms:",e.length),c(e),p(e.reduce((e,t)=>e+(t.unread_count||0),0))}),e.on("online-users",e=>{console.log("\uD83D\uDC65 Online users:",e.length),m(e)}),e.on("new-message",e=>{let{roomId:t,message:l}=e;console.log("\uD83D\uDCAC New message in room",t),g(e=>({...e,[t]:[...e[t]||[],l]})),p(e=>e+1)}),e.on("user-status",e=>{let{userId:t,status:l}=e;console.log("\uD83D\uDC64 User ".concat(t," is now ").concat(l)),m(e=>e.map(e=>e.id===t?{...e,status:l}:e))}),e.on("user-typing",e=>{let{roomId:t,userId:l,user:s,isTyping:a}=e;v(e=>{let r={...e[t]||{}};return a?r[l]=s:delete r[l],{...e,[t]:r}})}),e.on("message-read",e=>{let{messageId:t,userId:l}=e;console.log("✅ Message ".concat(t," read by user ").concat(l))}),e.on("new-room",e=>{console.log("\uD83C\uDD95 Added to new room:",e.name),c(t=>[...t,e])}),e.on("room-created",e=>{console.log("✨ Room created:",e.name),c(t=>[...t,e])}),e.on("message-edited",e=>{let{messageId:t,roomId:l,message:s}=e;console.log("✏️ Message edited"),g(e=>({...e,[l]:(e[l]||[]).map(e=>e.id===t?{...e,message:s,is_edited:!0}:e)}))}),e.on("message-deleted",e=>{let{messageId:t,roomId:l}=e;console.log("\uD83D\uDDD1️ Message deleted"),g(e=>({...e,[l]:(e[l]||[]).map(e=>e.id===t?{...e,is_deleted:!0,message:"This message was deleted"}:e)}))}),e.on("error",e=>{console.error("❌ Chat error:",e)}),i(e),()=>{console.log("\uD83D\uDD0C Closing chat connection"),e.close()}},[null==l?void 0:l.id]);let j=(0,a.useCallback)(function(e,t){let l=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"text";o&&h&&o.emit("send-message",{roomId:e,message:t,messageType:l})},[o,h]),w=(0,a.useCallback)(e=>{o&&h&&o.emit("create-direct-room",{targetUserId:e})},[o,h]),N=(0,a.useCallback)((e,t,l,s)=>{o&&h&&o.emit("create-room",{name:e,type:t,description:l,memberIds:s})},[o,h]),C=(0,a.useCallback)(e=>{o&&h&&(o.emit("mark-room-read",{roomId:e}),c(t=>t.map(t=>t.id===e?{...t,unread_count:0}:t)),p(t=>{var l;return Math.max(0,t-((null==(l=d.find(t=>t.id===e))?void 0:l.unread_count)||0))}))},[o,h,d]),k=(0,a.useCallback)(e=>{o&&h&&o.emit("typing",{roomId:e,isTyping:!0})},[o,h]),_=(0,a.useCallback)(e=>{o&&h&&o.emit("typing",{roomId:e,isTyping:!1})},[o,h]),S=(0,a.useCallback)((e,t,l)=>{o&&h&&o.emit("edit-message",{messageId:e,newMessage:t,roomId:l})},[o,h]),D=(0,a.useCallback)((e,t)=>{o&&h&&o.emit("delete-message",{messageId:e,roomId:t})},[o,h]),E=(0,a.useCallback)(e=>{o&&h&&o.emit("update-status",{status:e})},[o,h]);return(0,s.jsx)(n.Provider,{value:{socket:o,connected:h,rooms:d,onlineUsers:u,messages:x,unreadCount:f,typingUsers:y,sendMessage:j,createDirectRoom:w,createRoom:N,markRoomAsRead:C,startTyping:k,stopTyping:_,editMessage:S,deleteMessage:D,updateStatus:E,setMessages:g},children:t})}let i=()=>{let e=(0,a.useContext)(n);if(!e)throw Error("useChat must be used within a ChatProvider");return e}},8909:(e,t,l)=>{Promise.resolve().then(l.bind(l,9030))},9030:(e,t,l)=>{"use strict";l.r(t),l.d(t,{default:()=>n});var s=l(5155),a=l(2115),r=l(5171);function n(){let{connected:e,rooms:t,onlineUsers:l,messages:n,unreadCount:o,typingUsers:i,sendMessage:d,createDirectRoom:c,createRoom:u,markRoomAsRead:m,startTyping:x,stopTyping:g,setMessages:h}=(0,r.Y)(),[b,f]=(0,a.useState)(null),[p,y]=(0,a.useState)(""),[v,j]=(0,a.useState)(!1),[w,N]=(0,a.useState)(""),[C,k]=(0,a.useState)(null),_=(0,a.useRef)(null),S=(0,a.useRef)(null);(0,a.useEffect)(()=>{fetch("/api/auth/me").then(e=>e.json()).then(e=>{e.user&&k(e.user)}).catch(e=>console.error("Error fetching user:",e))},[]);let D=async e=>{try{let t=await fetch("".concat("http://localhost:3001","/api/chat/rooms/").concat(e,"/messages?userId=1&limit=100")),l=await t.json();l.success&&h(t=>({...t,[e]:l.messages}))}catch(e){console.error("Error loading messages:",e)}};(0,a.useEffect)(()=>{b&&(D(b.id),m(b.id))},[b]);let E=b?n[b.id]:null;(0,a.useEffect)(()=>{var e;null==(e=_.current)||e.scrollIntoView({behavior:"smooth"})},[E]);let O=e=>{c(e),j(!1)},T=e=>{if("direct"===e.type){var t;let l=null==(t=e.members)?void 0:t.find(e=>e.id!==(null==C?void 0:C.id));return(null==l?void 0:l.full_name)||e.name}return e.name},G=t.filter(e=>T(e).toLowerCase().includes(w.toLowerCase())),A=()=>{if(!b||!i[b.id])return null;let e=Object.values(i[b.id]).filter(e=>e&&e.full_name);return 0===e.length?null:1===e.length?"".concat(e[0].full_name," is typing..."):2===e.length?"".concat(e[0].full_name," and ").concat(e[1].full_name," are typing..."):"".concat(e.length," people are typing...")};return(0,s.jsxs)("div",{className:"h-[calc(100vh-80px)] flex gap-4",children:[(0,s.jsxs)("div",{className:"w-80 bg-gradient-to-br from-gray-900/80 to-gray-900/40 backdrop-blur-sm border border-gray-800/50 rounded-2xl p-4 flex flex-col",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,s.jsxs)("h2",{className:"text-xl font-bold text-white flex items-center gap-2",children:["\uD83D\uDCAC Chats",!e&&(0,s.jsx)("span",{className:"text-xs text-red-400",children:"(Offline)"})]}),(0,s.jsx)("button",{onClick:()=>j(!0),className:"w-8 h-8 bg-yellow-400 hover:bg-yellow-500 text-black rounded-lg flex items-center justify-center font-bold transition-all",title:"Start new chat",children:"+"})]}),(0,s.jsx)("input",{type:"text",placeholder:"Search chats...",value:w,onChange:e=>N(e.target.value),className:"w-full px-4 py-2 bg-gray-800/60 border border-gray-700/50 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:border-yellow-400 mb-4 text-sm"}),(0,s.jsx)("div",{className:"flex-1 overflow-y-auto space-y-2",children:G.map(e=>(0,s.jsxs)("div",{onClick:()=>{f(e),m(e.id)},className:"p-3 rounded-xl cursor-pointer transition-all ".concat((null==b?void 0:b.id)===e.id?"bg-gradient-to-r from-yellow-400/20 to-yellow-500/20 border border-yellow-400/30":"bg-gray-800/40 hover:bg-gray-800/60 border border-gray-700/30"),children:[(0,s.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,s.jsxs)("h3",{className:"font-semibold text-white text-sm truncate flex-1",children:["channel"===e.type&&"# ",T(e)]}),e.unread_count>0&&(0,s.jsx)("span",{className:"bg-red-500 text-white text-xs px-2 py-0.5 rounded-full font-bold",children:e.unread_count})]}),e.last_message&&(0,s.jsxs)("p",{className:"text-xs text-gray-400 truncate",children:[e.last_message.sender_name,": ",e.last_message.message]})]},e.id))})]}),(0,s.jsx)("div",{className:"flex-1 bg-gradient-to-br from-gray-900/80 to-gray-900/40 backdrop-blur-sm border border-gray-800/50 rounded-2xl flex flex-col overflow-hidden",children:b?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"p-4 border-b border-gray-800/50",children:[(0,s.jsxs)("h2",{className:"text-xl font-bold text-white",children:["channel"===b.type&&"# ",T(b)]}),b.description&&(0,s.jsx)("p",{className:"text-sm text-gray-400",children:b.description}),"General"===b.name&&"channel"===b.type&&(null==C?void 0:C.role)!=="admin"&&(0,s.jsx)("p",{className:"text-xs text-yellow-400 mt-1",children:"\uD83D\uDD12 Only admins can send messages in this channel"})]}),(0,s.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:[(n[b.id]||[]).map(e=>{let t=e.sender_id===(null==C?void 0:C.id);return(0,s.jsx)("div",{className:"flex ".concat(t?"justify-end":"justify-start"),children:(0,s.jsxs)("div",{className:"max-w-[70%] rounded-xl p-3 ".concat(t?"bg-gradient-to-r from-yellow-400 to-yellow-500 text-black":"bg-gray-800/60 text-white"," ").concat(e.is_deleted?"opacity-50 italic":""),children:[!t&&(0,s.jsx)("p",{className:"text-xs font-semibold mb-1 opacity-80",children:e.sender_name}),(0,s.jsx)("p",{className:"text-sm break-words",children:e.message}),(0,s.jsxs)("div",{className:"flex items-center justify-between gap-2 mt-1",children:[(0,s.jsx)("p",{className:"text-xs opacity-60",children:new Date(e.created_at).toLocaleTimeString()}),e.is_edited&&(0,s.jsx)("span",{className:"text-xs opacity-60",children:"(edited)"})]})]})},e.id)}),(0,s.jsx)("div",{ref:_})]}),A()&&(0,s.jsx)("div",{className:"px-4 py-2 text-sm text-gray-400 italic",children:A()}),(0,s.jsx)("form",{onSubmit:e=>{if(e.preventDefault(),b&&"General"===b.name&&"channel"===b.type&&(null==C?void 0:C.role)!=="admin")return void alert("Only admins can send messages in the General channel");p.trim()&&b&&(d(b.id,p),y(""),g(b.id))},className:"p-4 border-t border-gray-800/50",children:(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)("input",{type:"text",value:p,onChange:e=>{y(e.target.value),b&&e.target.value.length>0?(x(b.id),S.current&&clearTimeout(S.current),S.current=setTimeout(()=>{g(b.id)},3e3)):b&&g(b.id)},placeholder:"General"===b.name&&"channel"===b.type&&(null==C?void 0:C.role)!=="admin"?"Only admins can send messages here...":"Type a message...",className:"flex-1 px-4 py-3 bg-gray-800/60 border border-gray-700/50 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:border-yellow-400 focus:ring-2 focus:ring-yellow-400/20",disabled:!e||"General"===b.name&&"channel"===b.type&&(null==C?void 0:C.role)!=="admin"}),(0,s.jsx)("button",{type:"submit",disabled:!e||!p.trim()||"General"===b.name&&"channel"===b.type&&(null==C?void 0:C.role)!=="admin",className:"px-6 py-3 bg-gradient-to-r from-yellow-400 to-yellow-500 hover:from-yellow-500 hover:to-yellow-600 text-black font-bold rounded-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed",children:"Send"})]})})]}):(0,s.jsx)("div",{className:"flex-1 flex items-center justify-center text-gray-400",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("span",{className:"text-6xl mb-4 block",children:"\uD83D\uDCAC"}),(0,s.jsx)("p",{className:"text-xl",children:"Select a chat to start messaging"})]})})}),(0,s.jsxs)("div",{className:"w-64 bg-gradient-to-br from-gray-900/80 to-gray-900/40 backdrop-blur-sm border border-gray-800/50 rounded-2xl p-4",children:[(0,s.jsxs)("h3",{className:"text-lg font-bold text-white mb-4",children:["Online (",l.filter(e=>"online"===e.status&&e.id!==(null==C?void 0:C.id)).length,")"]}),(0,s.jsx)("div",{className:"space-y-2",children:l.filter(e=>e.id!==(null==C?void 0:C.id)).map(e=>{var t,l;return(0,s.jsxs)("div",{className:"flex items-center gap-3 p-2 rounded-lg hover:bg-gray-800/40 cursor-pointer transition-all",onClick:()=>O(e.id),title:"Start chat with ".concat(e.full_name),children:[(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center text-white font-bold",children:null==(l=e.full_name)||null==(t=l[0])?void 0:t.toUpperCase()}),(0,s.jsx)("span",{className:"absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-gray-900 ".concat("online"===e.status?"bg-green-400":"away"===e.status?"bg-yellow-400":"busy"===e.status?"bg-red-400":"bg-gray-400")})]}),(0,s.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,s.jsx)("p",{className:"text-sm font-semibold text-white truncate",children:e.full_name}),(0,s.jsx)("p",{className:"text-xs text-gray-400 truncate",children:e.status||"offline"})]})]},e.id)})})]}),v&&(0,s.jsx)("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",children:(0,s.jsxs)("div",{className:"bg-gradient-to-br from-gray-900/95 to-gray-900/80 border border-gray-800/50 rounded-2xl p-6 max-w-md w-full mx-4 shadow-2xl",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between mb-6",children:[(0,s.jsx)("h3",{className:"text-2xl font-bold text-white",children:"Start New Chat"}),(0,s.jsx)("button",{onClick:()=>j(!1),className:"w-8 h-8 rounded-lg hover:bg-gray-800/60 flex items-center justify-center text-gray-400 hover:text-white transition-all",children:"✕"})]}),(0,s.jsx)("p",{className:"text-gray-400 text-sm mb-4",children:"Select a user to start a direct message:"}),(0,s.jsx)("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:l.filter(e=>e.id!==(null==C?void 0:C.id)).map(e=>{var t,l;return(0,s.jsxs)("div",{onClick:()=>O(e.id),className:"flex items-center gap-3 p-3 rounded-xl hover:bg-gray-800/60 cursor-pointer transition-all border border-gray-800/30 hover:border-yellow-400/30",children:[(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center text-white font-bold",children:null==(l=e.full_name)||null==(t=l[0])?void 0:t.toUpperCase()}),(0,s.jsx)("span",{className:"absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-gray-900 ".concat("online"===e.status?"bg-green-400":"away"===e.status?"bg-yellow-400":"busy"===e.status?"bg-red-400":"bg-gray-400")})]}),(0,s.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,s.jsx)("p",{className:"text-sm font-semibold text-white truncate",children:e.full_name}),(0,s.jsx)("p",{className:"text-xs text-gray-400 truncate",children:e.email})]}),(0,s.jsx)("span",{className:"text-xs px-2 py-1 rounded-lg font-semibold ".concat("admin"===e.role?"bg-purple-500/20 text-purple-400":"developer"===e.role?"bg-blue-500/20 text-blue-400":"bg-green-500/20 text-green-400"),children:e.role})]},e.id)})}),0===l.filter(e=>e.id!==(null==C?void 0:C.id)).length&&(0,s.jsxs)("div",{className:"text-center py-8 text-gray-500",children:[(0,s.jsx)("span",{className:"text-4xl mb-2 block",children:"\uD83D\uDC65"}),(0,s.jsx)("p",{children:"No other users available"})]})]})})]})}}},e=>{e.O(0,[829,441,255,358],()=>e(e.s=8909)),_N_E=e.O()}]);